<script type="text/javascript">
var addLinktype = function(){
	var $id = $('#new-linktype-form');
	var linktypeVars = getLinktypeValues($id);
	
	$.post('/linktypes',
		  'action=add&data=' + escape(JSON.stringify(linktypeVars)),
		  function(data){
				if(data.status === 'Success.'){
					insertLinktype(data.linktype);
					updateLinktypes()
					notify($('#add'), '', data.status, 'bg-success', 2000);
				} else {
					notify($('#add'), '', data.status, 'bg-danger', 4000);
				}
		  }, 'json');
}

var updateLinktypes = function(){
	var linktypeVars = getAllLinktypeValues();
	
	$.post('/linktypes', 
			'action=update&data=' + escape(JSON.stringify(linktypeVars)),
		  function(data){
				if(data.status === 'Success.'){
					listLinktypes();
				} else {
					notify($('#update-linktypes'), '', data.status, 'bg-danger', 4000);
				}
		  }, 'json');
}

var deleteLinktype = function($id){
	var linktypeVars = {
					  'linkhost' : $id.find('input[name=linkhost]').val()
					  };
	$.post('/linktypes',
		   'action=delete&data=' + escape(JSON.stringify(linktypeVars)),
		function(data){
			if (data.status === 'Success.') {
				var alert = "<tr id=\"dismiss\"><td colspan=\"3\"><div class=\"alert alert-success\" role=\"alert\">Deleted.</div></td></tr>";
				$id.replaceWith(alert);
				setTimeout(function() {
					$('#dismiss').remove()
				}, 2000);
			} else {
				notify($id.find('button.delete'), '', data.status, 'bg-danger', 4000);
			}
		}, 'json');
}


var getLinktypeValues = function($id){
	var linktypeVars = {};
	
	$id.find('input').not(':button').each(function(){
			if ( $(this).is(':checkbox') ){
				linktypeVars[this.name] = testCheckBox(this);
			} else {
				linktypeVars[this.name] = $(this).val()
			}
		});
	
	return linktypeVars;
}

var getAllLinktypeValues = function(){
	var linktypesVars = [];

	for ( var i = 0; i != linktypeCount; i++ ){
		linktypesVars.push(getLinktypeValues($('#l' + i)));
	}
	
	return linktypesVars;
}


var linktypeCount = 0;

var listLinktypes = function(callback){
	$.post('/linktypes',
	   'action=list',
	   function(data){
		if(data.status === 'Success.'){
			for ( var i = 0; i < linktypeCount; i++ ){
				$('#l' + i).remove();
			}
			linktypeCount = 0;
			
			for ( var i in data.linktypes ){
				insertLinktype(data.linktypes[i]);
			}

			if ( callback ){
				callback();
			}

		} else {
			var alert = "<tr><td colspan=\"4\"><div class=\"alert alert-danger alert-dismissible\" role=\"alert\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>"
				+ data.status + "</div></td></tr>";
			$('#linktype-list tbody').append(alert);
		}
	   },
	   'json');
}

var insertLinktype = function(data){
	var id = 'l' + linktypeCount;

	var newLinktype = document.getElementById('linktype-template').cloneNode(true);
	newLinktype.id = id;
	newLinktype.style.display = 'none';

	$('#linktype-list tbody').append(newLinktype);
	linktypeCount++;
	
	$id = $(newLinktype);
	fillInLinktype($id, data);

	$id.slideDown(400)
	
	return id;
}

var fillInLinktype = function($id, data){
	for (var i in data){
		if (data[i] === 'TRUE' || data[i] === 'FALSE'){
			if (data[i] === 'TRUE'){ $id.find('input[name=' + i + ']').attr('checked', true); }
		} else {
			$id.find('input[name=' + i + ']').val(data[i]);
		}
	}
	$id.find(':button').each(function(){
		$(this).data('item-id', $id);
	});
}

$(document).ready(function(){
	listLinktypes();
	
	$('[data-toggle="tooltip"]').tooltip();

	$('#add').click( function(){
			addLinktype();
		});
	$('#update-linktypes').click( function(){
			updateLinktypes();
		});
	$('#linktype-list').on('click', 'button.delete', function(){
			deleteLinktype($(this).data('item-id'));
		});
	$('#linktype-list').on('keyup', ':input[name=priority]', function(){
			$(this).val($(this).val().replace(/[^0-9]/g, ''));
		});
});
</script>
<div class="row">
	<div class="col-sm-8">
		<div class="panel panel-default">
			<div class="panel-body">
				<table id="linktype-list" class="table table-striped">
					<thead>
						<tr>
							<th style="width: 25px;">Enable</th>
							<th>Host/Url fragment</th>
							<th style="width: 75px;">Priority</th>
							<th style="width: 75px;">Delete</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<button type="button" id="update-linktypes" class="btn btn-info"
					data-toggle="popover">Update Link Type list</button>
			</div>
		</div>
	</div>
	<div class="col-sm-4">
		<div class="panel panel-default">
			<div class="panel-heading"><h4 class="panel-title">Add a new link type:</h4></div>
			<div id="new-linktype-form" class="panel-body">
				<div class="form-group">
					<label for="linkhost">Host/Url fragment::</label> <input type="text"
						name="linkhost" class="form-control" data-toggle="tooltip"
						data-placement="left"
						title="This text will be matched against the url of the links found in the rss feeds.">
				</div>
				<div class="form-group">
					<label for="interval">Priority:</label> <input type="number"
						class="form-control" data-toggle="tooltip" data-placement="left"
						name="priority" value="10"
						title="Only the first matched link will be downloaded. Link types with lower priority values will take precedence.">
				</div>
				<button type="button" id="add" class="btn btn-primary" data-toggle="popover">Add
					link type</button>
			</div>
		</div>
	</div>
</div>
<table style="display: none;">
	<tr id="linktype-template" style="display: none;">
		<td><input type="checkbox" name="enabled"></td>
		<td class="linktype-item"><input type="text" name="linkhost"
			class="form-control" disabled="disabled"></td>
		<td><input name="priority" type="number" class="form-control"></td>
		<td>
			<button type="button" class="btn btn-danger delete">Delete</button>
		</td>
	</tr>
</table>
