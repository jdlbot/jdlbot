<script type="text/javascript">
	var addFeed = function($caller) {
		var $id = $('#new-feed-form');
		var feedVars = getFeedValues($id);

		$.post('/feeds', 'action=add&data=' + escape(JSON.stringify(feedVars))).done(
				function(data) {
					if (data.status === "Success.") {
						insertFeed(data);
						notify($('#add'), '', data.status, 'bg-success', 2000);
					} else {
						notify($('#add'), '', data.status, 'bg-danger', 4000);
					}
				}).fail(function(data) {
			notify($('#add'), '', 'Connection Error', 'bg-danger', 4000);
		});
	}

	var updateFeed = function($id) {
		var feedVars = getFeedValues($id);

		$.post('/feeds', 'action=update&data=' + escape(JSON.stringify(feedVars)),
				function(data) {
					if (data.status === 'Success.') {
						fillInFeed($id, data);
						toggleShow($id);
						notify($id.find('button.edit-button'), '', data.status, 'bg-success',
								2000);
					} else {
						notify($id.find('button.edit-button'), '', data.status, 'bg-danger',
								4000);
					}
				}, 'json');
	}

	var enableFeed = function($id) {
		var feedVars = {
			'url' : $id.find('input[name=old_url]').val(),
			'old_url' : $id.find('input[name=old_url]').val(),
			'enabled' : testCheckBox($id.find('input[name=enabled]'))
		};
		$.post('/feeds', 'action=enable&data=' + escape(JSON.stringify(feedVars)),
				function(data) {
					if (data.status === 'Success.') {
						notify($id.find('button.edit-button'), '', data.status, 'bg-success',
								2000);
					} else {
						notify($id.find('button.edit-button'), '', data.status, 'bg-danger',
								4000);
					}
				}, 'json');
	}

	var deleteFeed = function($id) {
		var feedVars = {
			'url' : $id.find('input[name=url]').val()
		};
		$
				.post(
						'/feeds',
						'action=delete&data=' + escape(JSON.stringify(feedVars)),
						function(data) {
							if (data.status === 'Success.') {
								var alert = "<tr id=\"dismiss\"><td colspan=\"3\"><div class=\"alert alert-success\" role=\"alert\">Deleted.</div></td></tr>";
								$id.replaceWith(alert);
								setTimeout(function() {
									$('#dismiss').remove()
								}, 2000);
							} else {
								notify($id.find('button.edit-button'), '', data.status, 'bg-danger',
										4000);
							}
						}, 'json');
	}

	var listFeeds = function(callback) {
		$
				.post(
						'/feeds',
						'action=list',
						function(data) {
							if (data.status === 'Success.') {
								for (var i = 0; i < feedCount; i++) {
									$('#f' + i).remove();
								}
								feedCount = 0;

								for ( var i in data.feeds) {
									insertFeed(data.feeds[i]);
								}

								if (callback) {
									callback();
								}

							} else {
								var alert = "<tr><td colspan=\"3\"><div class=\"alert alert-danger alert-dismissible\" role=\"alert\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>"
										+ data.status + "</div></td></tr>";
								$('#feed-list tbody').append(alert);
							}
						}, 'json');
	}

	var getFeedValues = function($id) {
		var feedVars = {};

		$id.find('input').not(':button').each(function() {
			if ($(this).is(':checkbox')) {
				feedVars[this.name] = testCheckBox(this);
			} else {
				feedVars[this.name] = $(this).val()
			}
		});

		return feedVars;
	}

	var insertFeed = function(data) {
		var id = 'f' + feedCount;

		var newFeed = document.getElementById('feed-template').cloneNode(true);
		newFeed.id = id;
		newFeed.style.display = 'none';

		$('#feed-list tbody').append(newFeed);
		feedCount++;

		$id = $('#' + id);
		fillInFeed($id, data);

		$id.slideDown(400)

		return id;
	}

	var fillInFeed = function($id, data) {
		$id.find('td.feed-item span').html(
				'<a href="http://' + data.url + '" target="_blank">' + data.url
						+ ' -- Interval: ' + data.interval + '</a>');
		for ( var field in data) {
			if (data[field] === 'TRUE' || data[field] === 'FALSE') {
				if (data[field] === 'TRUE') {
					$id.find('input[name=' + field + ']').prop('checked', true);
				}
			} else {
				$id.find('input[name=' + field + ']').val(data[field]);
			}
		}
		$id.find('input[name=old_url]').val(data.url);
		$id.find('button').each(function() {
			$(this).data('item-id', $id);
		});
		$id.find('input').each(function() {
			$(this).data('item-id', $id);
		});
	}

	var feedCount = 0;
	$(document).ready(function() {
		$('[data-toggle="tooltip"]').tooltip();

		$('#add').click(function() {
			addFeed($(this));
		});
		$('#feed-list').on('change', ':checkbox[name=enabled]', function() {
			enableFeed($(this).data('item-id'));
		});
		$('#feed-list').on('click', 'button.edit-button', function() {
			toggleShow($(this).data('item-id'));
		});
		$('#feed-list').on('click', 'button.update', function() {
			updateFeed($(this).data('item-id'));
		});
		$('#feed-list').on('click', 'button.delete', function() {
			deleteFeed($(this).data('item-id'));
		});
		$('#feed-list').on('click', 'button.cancel', function() {
			toggleShow($(this).data('item-id'));
		});

		listFeeds();
	});
</script>
<div class="row">
	<div class="col-sm-8">
		<div class="panel panel-default">
			<div class="panel-body">
				<table id="feed-list" class="table table-striped">
					<thead>
						<tr>
							<th style="width: 25px;">Enable</th>
							<th>Feed</th>
							<th style="width: 75px;">Edit</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>
	</div>
	<div class="col-sm-4">
		<div class="panel panel-default">
			<div class="panel-heading">Add a new feed:</div>
			<div id="new-feed-form" class="panel-body">
				<div class="form-group">
					<label for="url">Url:</label> <input type="text" name="url" class="form-control"
						data-toggle="tooltip" data-placement="left" title="The url must be unique.">
				</div>
				<div class="form-group">
					<label for="interval">Interval (min):</label> <input type="number"
						class="form-control" data-toggle="tooltip" data-placement="left"
						name="interval" value="60"
						title="The interval in minutes between RSS feed checks.  Something 60 or over is usually appropriate.">
				</div>
				<div class="checkbox">
					<label><input type="checkbox" name="follow_links" data-toggle="tooltip"
						data-placement="left"
						title="If checked, the link in the RSS item will be followed and the page scraped for links to add to JD">
						Follow Links. </label>
				</div>
				<button type="button" id="add" class="btn btn-primary" data-toggle="popover">Add
					feed</button>
			</div>
		</div>
	</div>
</div>
<table style="display: none;">
	<tr id="feed-template" style="display: none;">
		<td><input type="checkbox" name="enabled"></td>
		<td class="feed-item"><span></span>
			<div class="panel panel-default edit" style="display: none;">
				<div class="panel-heading">Edit feed:</div>
				<div class="panel-body">
					<div class="form-group">
						<label for="url">Url:</label> <input type="text" name="url"
							class="form-control" value=""> <input type="hidden" name="old_url"
							value="">
					</div>
					<div class="form-group">
						<label for="interval">Interval (min):</label> <input type="number"
							name="interval" class="form-control" value="">
					</div>
					<div class="checkbox">
						<label><input type="checkbox" name="follow_links"> Follow
							Links. </label>
					</div>
					<div class="btn-group" role="group" aria-label="save cancel delete button group">
						<button type="button" class="btn btn-primary update">Update</button>
						<button type="button" class="btn btn-danger delete">Delete</button>
						<button type="button" class="btn btn-info cancel">Cancel</button>
					</div>
				</div>
			</div></td>
		<td>
			<button type="button" class="btn btn-info edit-button" data-placement="top">Edit</button>
		</td>
	</tr>
</table>
