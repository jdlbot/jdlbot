<script type="text/javascript">
	var addFilter = function() {
		var $id = $('#new-filter-form');
		var filterVars = getFilterValues($id);
		$.post('/filters', 'action=add&data=' + escape(JSON.stringify(filterVars)))
				.done(function(data) {
					if (data.status === "Success.") {
						insertFilter(data.filter);
						notify($('#add'), '', data.status, 'bg-success', 2000);
					} else {
						notify($('#add'), '', data.status, 'bg-danger', 4000);
					}
				}).fail(function(data) {
					notify($('#add'), '', 'Connection Error', 'bg-danger', 4000);
				});
	}

	var updateFilter = function($id) {
		var filterVars = getFilterValues($id);
		$.post('/filters', 'action=update&data=' + escape(JSON.stringify(filterVars)),
				function(data) {
					if (data.status === 'Success.') {
						fillInFilter($id, data.filter);
						toggleShow($id);
						notify($id.find('button.edit-button'), '', data.status, 'bg-success',
								2000);
					} else {
						notify($id.find('button.edit-button'), '', data.status, 'bg-danger',
								4000);
					}
				}, 'json');
	}

	var enableFilter = function($id) {
		var filterVars = {
			'old_title' : $id.find('input[name=old_title]').val(),
			'enabled' : testCheckBox($id.find('input[name=enabled]'))
		};
		$.post('/filters', 'action=update&data=' + escape(JSON.stringify(filterVars)),
				function(data) {
					if (data.status === 'Success.') {
						notify($id.find('button.edit-button'), '', data.status, 'bg-success',
								2000);
					} else {
						notify($id.find('button.edit-button'), '', data.status, 'bg-danger',
								4000);
					}
				}, 'json');
	}

	var deleteFilter = function($id) {
		var filterVars = {
			'title' : $id.find('input[name=old_title]').val()
		};
		$
				.post(
						'/filters',
						'action=delete&data=' + escape(JSON.stringify(filterVars)),
						function(data) {
							if (data.status === 'Success.') {
								var alert = "<tr id=\"dismiss\"><td colspan=\"3\"><div class=\"alert alert-success\" role=\"alert\">Deleted.</div></td></tr>";
								$id.replaceWith(alert);
								setTimeout(function() {
									$('#dismiss').remove()
								}, 2000);
							} else {
								notify($id.find('button.edit-button'), '', data.status, 'bg-danger',
										4000);
							}
						}, 'json');
	}

	var listFilters = function() {
		var filterVars = {};
		$
				.post(
						'/filters',
						'action=list&data=' + escape(JSON.stringify(filterVars)),
						function(data) {
							if (data.status === 'Success.') {
								for (var i = 0; i < filterCount; i++) {
									$('#f' + i).remove();
								}
								filterCount = 0;

								for ( var i in data.filters) {
									insertFilter(data.filters[i]);
								}

							} else {
								var alert = "<tr><td colspan=\"3\"><div class=\"alert alert-danger alert-dismissible\" role=\"alert\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>"
										+ data.status + "</div></td></tr>";
								$('#feed-list tbody').append(alert);
							}
						}, 'json');
	}

	var listFeeds = function(callback) {
		$
				.post(
						'/feeds',
						'action=list',
						function(data) {
							if (data.status === 'Success.') {
								for ( var i in data.feeds) {
									var feed = '<li><input type="checkbox" value="' + data.feeds[i].url + '" /> '
											+ data.feeds[i].url + '</li>';
									$('ul.feed_list').append(feed);
								}

								if (callback) {
									callback();
								}

							} else {
								notify($('#add'), '', data.status, 'bg-danger', 4000);
							}
						}, 'json');
	}

	var getFilterValues = function($id) {
		var filterVars = {};

		$id.find('input').not('ul.feed_list input').not(':button').each(function() {
			if ($(this).is(':checkbox')) {
				filterVars[this.name] = testCheckBox(this);
			} else {
				filterVars[this.name] = $(this).val();
			}
		});
		filterVars.feeds = function() {
			var feeds_checked = [];
			$id.find('ul.feed_list :checked').each(function() {
				feeds_checked.push($(this).val());
			});

			return JSON.stringify(feeds_checked);
		}();

		return filterVars;
	}

	var insertFilter = function(data) {
		var id = 'f' + filterCount;

		var newFilter = document.getElementById('filter-template').cloneNode(true);
		newFilter.id = id;
		newFilter.style.display = 'none';

		$('#filter-list tbody').append(newFilter);
		filterCount++;

		$id = $('#' + id);
		fillInFilter($id, data);

		$id.slideDown(400)

		return id;
	}

	var fillInFilter = function($id, data) {

		if (data.tv_last !== "") {
			$id.find('td.filter-item span.item-title').text(
					data.title + " - Last Episode: " + data.tv_last);
		} else {
			$id.find('td.filter-item span.item-title').text(data.title);
		}
		for ( var i in data) {
			if (data[i] === 'TRUE' || data[i] === 'FALSE') {
				if (data[i] === 'TRUE') {
					$id.find('input[name=' + i + ']').prop('checked', true);
					if (i !== 'enabled') {
						$id.find('input[name=' + i + ']').change();
					}
				}
			} else if (i === 'feeds') {
				var feeds = JSON.parse(data[i]);
				$id.find('ul.feed_list input').each(function() {
					for ( var i in feeds) {
						if ($(this).val() === feeds[i]) {
							$(this).prop('checked', true);
							return;
						}
					}
				});
			} else {
				$id.find('input[name=' + i + ']').val(data[i]);
			}
		}
		$id.find('input[name=old_title]').val(data.title);
		$id.find('button').each(function() {
			$(this).data('item-id', $id);
		});
		$id.find('input[name=enabled]').data('item-id', $id);
	}

	var toggle = function($id) {
		if ($id.is(':hidden')) {
			$id.show();
		} else {
			$id.hide();
		}
	}

	var filterCount = 0;
	$(document).ready(
			function() {
				// Add tips for the new filter input
				$('[data-toggle="tooltip"]').tooltip();

				// Add event handlers for everything.  Most are delegated at the bubble-up stage.
				$('#filters').on('change',
						':checkbox[name=stop_found]',
						function() {
							if (this.checked) {
								$(this).parents('div.panel-body')
										.find(':checkbox[name=tv]:checked').each(function() {
											$(this).prop('checked', false);
											$(this).change();
										});
							}
						});
				$('#filters').on('change',':checkbox[name=tv]',
						function() {
							toggle($(this).parents('div.panel-body').find('div.tv_last'));
							if (this.checked) {
								$(this).parents('div.panel-body').find(':checkbox[name=stop_found]')
										.prop('checked', false);
							}
						});
				$('#filters').on('change', ':checkbox[name=enabled]', function() {
					enableFilter($(this).data('item-id'));
				});
				$('#filters').on('click', 'button.update', function() {
					updateFilter($(this).data('item-id'));
				});
				$('#filters').on('click', 'button.delete', function() {
					deleteFilter($(this).data('item-id'));
				});
				$('#filters').on('click', 'button.cancel', function() {
					toggleShow($(this).data('item-id'));
				});
				$('#filters').on('click', 'button.edit-button', function() {
					toggleShow($(this).data('item-id'));
				});
				$('#add').click(function() {
					addFilter();
				});

				// Grab the list of feeds, then grab the list of filters.
				listFeeds(listFilters);
			});
</script>
<div class="row" id="filters">
	<div class="col-sm-7">
		<table id="filter-list" class="table table-striped">
			<thead>
				<tr>
					<th style="width: 25px;">Enable</th>
					<th>Filter</th>
					<th style="width: 75px;">Edit</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>
	<div class="col-sm-5">
		<div class="panel panel-default">
			<div class="panel-heading">Add a new filter:</div>
			<div id="new-filter-form" class="panel-body">
				<div class="form-group">
					<label for="title">Title:</label> <input type="text" name="title"
						class="form-control" data-toggle="tooltip" data-placement="left"
						title="The filter title must be unique.">
				</div>
				<div class="form-group">
					<label for="filter1">Filter 1:</label>
					<div class="input-group">
						<input type="text" name="filter1" class="form-control" data-toggle="tooltip"
							data-placement="left"
							title="You should be as specific as possible.  While a blank filter is permissible, you will match EVERY link entry in an RSS feed.">
						<span class="input-group-addon"> <input type="checkbox" name="regex1">
							Regex?
						</span>
					</div>
				</div>
				<div class="form-group">
					<label for="filter2">Filter 2:</label>
					<div class="input-group">
						<input type="text" name="filter2" class="form-control" data-toggle="tooltip"
							data-placement="left"
							title="This filter is used as a secondary check if the feed is set to 'follow links'.  When the link is loaded, the page is searched for this term.  Typical use case could be an IMDB link to make sure you have the right movie.">
						<span class="input-group-addon"> <input type="checkbox" name="regex2">
							Regex?
						</span>
					</div>
				</div>
				<div class="form-group">
					<label>Feeds:</label>
					<ul class="feed_list" style="list-style: none;"></ul>
				</div>
				<div class="form-group">
					<label for="link_types">Link Types:</label> <input type="text" name="link_types"
						class="form-control" data-toggle="tooltip" data-placement="left"
						title="This field is to override the default link types to use in the <a href='/linktypes'>Link Types list</a>.  If the field is used, multiple types must be | delimited.  For example: megaupload|hotfile">
				</div>
				<div class="checkbox">
					<label><input type="checkbox" name="stop_found" data-toggle="tooltip"
						data-placement="left" checked
						title="Does exactly what it says.  If there is a positive match, and links are found this filter will be disabled.">
						Disable when found? </label>
					<div class="checkbox">
						<label><input type="checkbox" name="tv" data-toggle="tooltip"
							data-placement="left"
							title="This enables handling the filter as a TV series including additional configuration options.">
							TV series? </label>
					</div>
					<div class="form-group tv_last" style="display: none;">
						<label for="tv_last">Last downloaded episode:</label> <input type="text"
							name="tv_last" class="form-control" data-toggle="tooltip"
							data-placement="left"
							title="This field should be either a season and episode number (formatted as 'S01E01') or a date (formatted as '2010/10/30').  TV episodes that come after the designated 'last' will be downloaded. Optional.">
					</div>
					<div class="checkbox" style="display: none;">
						<label><input type="checkbox" name="autostart" data-toggle="tooltip"
							data-placement="left" checked
							title="All matching links will be added to the linkgrabber.  If this is checked, they will also be downloaded.">
							Auto start in jDownloader? </label>
					</div>
					<button type="button" id="add" class="btn btn-default" data-toggle="popover">Add
						filter</button>
				</div>
			</div>
		</div>
	</div>
</div>
<table style="display: none;">
	<tr id="filter-template" style="display: none;">
		<td><input type="checkbox" name="enabled"></td>
		<td class="filter-item"><span class="item-title"></span>
			<div class="panel panel-default edit" style="display: none;">
				<div class="panel-heading">Edit filter:</div>
				<div id="new-feed-form" class="panel-body">
					<div class="form-group">
						<label for="title">Title:</label> <input type="text" name="title"
							class="form-control"><input type="hidden" name="old_title" value="">
					</div>
					<div class="form-group">
						<label for="filter1">Filter 1:</label>
						<div class="input-group">
							<input type="text" name="filter1" class="form-control"> <span
								class="input-group-addon"> <input type="checkbox" name="regex1">
								Regex?
							</span>
						</div>
					</div>
					<div class="form-group">
						<label for="filter2">Filter 2:</label>
						<div class="input-group">
							<input type="text" name="filter2" class="form-control"> <span
								class="input-group-addon"> <input type="checkbox" name="regex2">
								Regex?
							</span>
						</div>
					</div>
					<div class="form-group">
						<label>Feeds:</label>
						<ul class="feed_list" style="list-style: none;"></ul>
					</div>
					<div class="form-group">
						<label for="link_types">Link Types:</label> <input type="text"
							name="link_types" class="form-control">
					</div>
					<div class="checkbox">
						<label><input type="checkbox" name="stop_found"> Disable when
							found? </label>
					</div>
					<div class="checkbox">
						<label><input type="checkbox" name="tv"> TV series? </label>
					</div>
					<div class="form-group tv_last" style="display: none;">
						<label for="tv_last">Last downloaded episode:</label> <input type="text"
							name="tv_last" class="form-control">
					</div>
					<div class="checkbox" style="display: none;">
						<label><input type="checkbox" name="autostart"> Auto start in
							jDownloader? </label>
					</div>
					<div class="btn-group" role="group" aria-label="save cancel delete button group">
						<button type="button" class="btn btn-default update">Update</button>
						<button type="button" class="btn btn-default delete">Delete</button>
						<button type="button" class="btn btn-default cancel">Cancel</button>
					</div>
				</div>
			</div></td>
		<td>
			<button type="button" class="btn btn-default edit-button" data-placement="top">Edit</button>
		</td>
	</tr>
</table>
